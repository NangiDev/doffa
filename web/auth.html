<!DOCTYPE html>
<html>

<head>
    <title>Authentication complete</title>
    <meta charset="utf-8">
</head>

<body>
    <p>Authentication is complete. If this does not happen automatically, please close the window.</p>
    <script>
        (function () {
            const hash = window.location.hash.substring(1);
            const redirectUri = `doffa://callback#${hash}`;

            // If we're in a mobile context (opened by flutter_web_auth), do redirect
            if (navigator.userAgent.includes('wv') ||
                navigator.userAgent.includes('Flutter') ||
                /doffa/i.test(document.referrer) ||
                window.location.search.includes('mobile=true')) {
                window.location.href = redirectUri;
            } else {
                // Web fallback (Flutter Web): communicate via postMessage or localStorage
                const message = { 'flutter-web-auth-2': window.location.href };
                if (window.opener) {
                    window.opener.postMessage(message, window.location.origin);
                    window.close();
                } else if (window.parent && window.parent !== window) {
                    window.parent.postMessage(message, window.location.origin);
                } else {
                    localStorage.setItem('flutter-web-auth-2', window.location.href);
                    window.close();
                }
            }
        })();
    </script>
</body>

</html>