<!DOCTYPE html>
<html>

<head>
    <title>Authentication complete</title>
    <meta charset="utf-8">
</head>

<body>
    <!-- Update paragraph depending on what happens in the script -->
    <p>Authentication is complete. If this does not happen automatically, please close the window.</p>
    <p id="log"></p>

    <script>
        (function () {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash); // Parse the fragment
            const query = params.toString(); // Reserialize as query

            // Clear the log paragraph and set the first log message
            const logElement = document.getElementById('log');
            logElement.innerText = 'Authentication complete: ' + query + '\n';

            console.log('Authentication complete:', query);

            // Debugging different checks for isMobile
            let debugMessage = '';

            // Check if it's in a mobile context (Flutter WebView / app)
            const userAgent = navigator.userAgent;
            debugMessage += 'User-Agent: ' + userAgent + '\n';
            const isWebView = userAgent.includes('wv');
            debugMessage += 'Is WebView: ' + isWebView + '\n';

            const isFlutter = userAgent.includes('Flutter');
            debugMessage += 'Is Flutter: ' + isFlutter + '\n';

            const isMobi = /Mobi|Android/i.test(userAgent);
            debugMessage += 'Is Mobi or Android: ' + isMobi + '\n';

            const referrerCheck = /doffa/i.test(document.referrer);
            debugMessage += 'Referrer contains "doffa": ' + referrerCheck + '\n';

            const searchParamMobile = window.location.search.includes('mobile=true');
            debugMessage += 'Search parameter includes "mobile=true": ' + searchParamMobile + '\n';

            // Log all debug information for isMobile
            logElement.innerText += 'Debugging isMobile check:\n' + debugMessage + '\n';

            // Final check for mobile context
            const isMobile = isWebView || isFlutter || isMobi || referrerCheck || searchParamMobile;

            console.log('Is mobile:', isMobile);
            logElement.innerText += 'Final isMobile result: ' + isMobile + '\n';

            if (isMobile) {
                // Redirect back to the mobile app via custom URI scheme
                const redirectUri = `com.nangidev.doffa://fitbit_auth?${query}`;

                logElement.innerText += 'Redirecting to mobile app: ' + redirectUri + '\n';
                window.location.href = redirectUri;
            } else {
                // Fallback to web (use postMessage or localStorage for Flutter web)
                const message = { 'flutter-web-auth-2': window.location.href };
                if (window.opener) {
                    window.opener.postMessage(message, '*');
                    window.close();
                } else if (window.parent && window.parent !== window) {
                    window.parent.postMessage(message, '*');
                } else {
                    localStorage.setItem('flutter-web-auth-2', window.location.href);
                    window.close();
                }
            }
        })();
    </script>
</body>

</html>